<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal64 API Demo - Adressen</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body class="address-page">
    <header class="header">
        <div class="container">
            <h1>Adressen API</h1>
            <p>Erkunden Sie Funktionäre und Amtsträger in verschiedenen Regionen</p>
            <p><a href="index.html" style="color: var(--light-gray); text-decoration: underline;">← Zurück zum Dashboard</a></p>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="tabs">
                <nav class="tab-nav">
                    <button class="tab-nav-item" data-tab="regions">Regionen</button>
                    <button class="tab-nav-item" data-tab="region-addresses">Adressen nach Region</button>
                    <button class="tab-nav-item" data-tab="address-types">Funktionstypen</button>
                </nav>

                <!-- Regions Tab -->
                <div id="regions" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Verfügbare Regionen</h2>
                        </div>
                        <p>Zeigt alle Regionen an, für die Adressinformationen verfügbar sind.</p>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <button onclick="loadRegions()" class="btn btn-primary">Regionen laden</button>
                            </div>
                            <div class="form-group">
                                <button onclick="exportRegions()" class="btn btn-secondary">Als CSV exportieren</button>
                            </div>
                        </div>

                        <div id="regions-result" class="mt-3">
                            <!-- Regions will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Region Addresses Tab -->
                <div id="region-addresses" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Adressen nach Region</h2>
                        </div>
                        <p>Suchen Sie nach Funktionären und Amtsträgern in einer bestimmten Region.</p>
                        
                        <form id="region-addresses-form" class="search-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="region-select">Region</label>
                                    <select id="region-select" name="region" class="form-select" required>
                                        <option value="">Region auswählen...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="address-type">Funktionstyp (optional)</label>
                                    <input type="text" id="address-type" name="type" class="form-input" 
                                           placeholder="z.B. praesidium, vorstand...">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary">Adressen suchen</button>
                                </div>
                            </div>
                        </form>

                        <div id="region-addresses-result" class="mt-3">
                            <!-- Region addresses will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Address Types Tab -->
                <div id="address-types" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Funktionstypen nach Region</h2>
                        </div>
                        <p>Zeigt verfügbare Funktionstypen für eine bestimmte Region an.</p>
                        
                        <form id="address-types-form" class="search-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="types-region-select">Region</label>
                                    <select id="types-region-select" name="region" class="form-select" required>
                                        <option value="">Region auswählen...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary">Funktionstypen laden</button>
                                </div>
                            </div>
                        </form>

                        <div id="address-types-result" class="mt-3">
                            <!-- Address types will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Portal64 API Demo. DWZ Schach-Bewertungssystem Schnittstelle.</p>
        </div>
    </footer>

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Load regions for both select elements
            loadRegionsForSelects();
        });

        // Global variable to store regions data
        let regionsData = [];

        // Load regions for dropdown selects
        async function loadRegionsForSelects() {
            try {
                const result = await api.getAvailableRegions();
                if (result.success && result.data) {
                    regionsData = result.data;
                    populateRegionSelects();
                }
            } catch (error) {
                console.error('Failed to load regions for selects:', error);
            }
        }

        // Populate region select elements
        function populateRegionSelects() {
            const regionSelect = document.getElementById('region-select');
            const typesRegionSelect = document.getElementById('types-region-select');
            
            // Clear existing options (except the first placeholder)
            regionSelect.innerHTML = '<option value="">Region auswählen...</option>';
            typesRegionSelect.innerHTML = '<option value="">Region auswählen...</option>';
            
            regionsData.forEach(region => {
                const option1 = new Option(`${region.name} (${region.code}) - ${region.address_count} Adressen`, region.code);
                const option2 = new Option(`${region.name} (${region.code}) - ${region.address_count} Adressen`, region.code);
                regionSelect.add(option1);
                typesRegionSelect.add(option2);
            });
        }

        // Load and display regions
        async function loadRegions() {
            try {
                Utils.showLoading('regions-result');
                const result = await api.getAvailableRegions();
                
                if (result.success && result.data) {
                    displayRegions(result.data);
                    new CodeDisplayManager().displayResponse('regions-result', result, 'Regionen API Antwort');
                } else {
                    Utils.showError('regions-result', result.error || 'Fehler beim Laden der Regionen');
                }
            } catch (error) {
                Utils.showError('regions-result', `Fehler beim Laden der Regionen: ${error.message}`);
            }
        }

        // Display regions in a formatted way
        function displayRegions(regions) {
            const container = document.getElementById('regions-result');
            
            let html = '<div class="data-table-container"><table class="data-table">';
            html += '<thead><tr><th>Code</th><th>Name</th><th>Anzahl Adressen</th></tr></thead>';
            html += '<tbody>';
            
            regions.forEach(region => {
                html += `<tr>
                    <td><strong>${region.code}</strong></td>
                    <td>${region.name}</td>
                    <td>${region.address_count}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // Prepend the table before the API response
            const existingContent = container.innerHTML;
            container.innerHTML = html + existingContent;
        }

        // Export regions as CSV
        async function exportRegions() {
            try {
                Utils.showLoading('regions-result');
                const result = await api.getAvailableRegions('csv');
                
                // Create and download CSV
                const blob = new Blob([result], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'regionen.csv';
                a.click();
                window.URL.revokeObjectURL(url);
                
                Utils.showSuccess('regions-result', 'CSV-Export erfolgreich heruntergeladen');
            } catch (error) {
                Utils.showError('regions-result', `CSV-Export fehlgeschlagen: ${error.message}`);
            }
        }

        // Handle region addresses form submission
        document.getElementById('region-addresses-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const region = formData.get('region');
            const type = formData.get('type');
            
            try {
                Utils.showLoading('region-addresses-result');
                
                const params = {};
                if (type) {
                    params.type = type;
                }
                
                const result = await api.getRegionAddresses(region, params);
                
                if (result.success && result.data) {
                    displayRegionAddresses(result.data);
                    new CodeDisplayManager().displayResponse('region-addresses-result', result, 'Adressen API Antwort');
                } else {
                    Utils.showError('region-addresses-result', result.error || 'Fehler beim Laden der Adressen');
                }
            } catch (error) {
                Utils.showError('region-addresses-result', `Fehler beim Laden der Adressen: ${error.message}`);
            }
        });

        // Display region addresses in a formatted way
        function displayRegionAddresses(addresses) {
            const container = document.getElementById('region-addresses-result');
            
            if (!addresses || addresses.length === 0) {
                container.innerHTML = '<p class="no-results">Keine Adressen gefunden für die ausgewählte Region.</p>';
                return;
            }
            
            let html = '<div class="data-table-container"><table class="data-table">';
            html += '<thead><tr><th>Name</th><th>Funktion</th><th>Organisation</th><th>Region</th><th>Kontakt</th></tr></thead>';
            html += '<tbody>';
            
            addresses.forEach(address => {
                const contactDetails = address.contact_details || [];
                const contactHtml = contactDetails.map(contact => 
                    `<div><strong>${contact.type}:</strong> ${contact.value}</div>`
                ).join('');
                
                html += `<tr>
                    <td><strong>${address.name}</strong></td>
                    <td>${address.function_name || '-'}</td>
                    <td>${address.organisation_name || '-'}</td>
                    <td>${address.region}</td>
                    <td>${contactHtml || '-'}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // Prepend the table before the API response
            const existingContent = container.innerHTML;
            container.innerHTML = html + existingContent;
        }

        // Handle address types form submission
        document.getElementById('address-types-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const region = formData.get('region');
            
            try {
                Utils.showLoading('address-types-result');
                const result = await api.getRegionAddressTypes(region);
                
                if (result.success && result.data) {
                    displayAddressTypes(result.data);
                    new CodeDisplayManager().displayResponse('address-types-result', result, 'Funktionstypen API Antwort');
                } else {
                    Utils.showError('address-types-result', result.error || 'Fehler beim Laden der Funktionstypen');
                }
            } catch (error) {
                Utils.showError('address-types-result', `Fehler beim Laden der Funktionstypen: ${error.message}`);
            }
        });

        // Display address types in a formatted way
        function displayAddressTypes(types) {
            const container = document.getElementById('address-types-result');
            
            if (!types || types.length === 0) {
                container.innerHTML = '<p class="no-results">Keine Funktionstypen gefunden für die ausgewählte Region.</p>';
                return;
            }
            
            let html = '<div class="data-table-container"><table class="data-table">';
            html += '<thead><tr><th>ID</th><th>Funktionsname</th><th>Anzahl</th></tr></thead>';
            html += '<tbody>';
            
            types.forEach(type => {
                html += `<tr>
                    <td>${type.id}</td>
                    <td><strong>${type.name}</strong></td>
                    <td>${type.count}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // Prepend the table before the API response
            const existingContent = container.innerHTML;
            container.innerHTML = html + existingContent;
        }
    </script>
</body>
</html>