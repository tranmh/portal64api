<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somatogramm - DWZ Percentile Charts</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .description {
            background-color: #e8f4fd;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
            border-left: 4px solid #0066cc;
        }
        .status-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .status-item {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .status-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        .status-value {
            font-size: 16px;
            margin-top: 5px;
        }
        .running {
            color: #ff6600;
        }
        .success {
            color: #00aa00;
        }
        .error {
            color: #cc0000;
        }
        .btn {
            background-color: #0066cc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .btn:hover {
            background-color: #0052a3;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .files-section {
            margin-top: 30px;
        }
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .gender-section {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .gender-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }
        .file-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .file-item {
            background-color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .file-info {
            flex-grow: 1;
        }
        .file-name {
            font-weight: bold;
            color: #333;
        }
        .file-meta {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .download-btn {
            background-color: #28a745;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        .download-btn:hover {
            background-color: #218838;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        .no-files {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Somatogramm - DWZ Percentile Charts</h1>

        <div class="description">
            <h3>About Somatogramm</h3>
            <p>The Somatogramm feature generates comprehensive DWZ percentile charts by age and gender, creating growth analysis reports for chess players. It analyzes DWZ distribution patterns across age groups to identify talent development trends.</p>
            <p><strong>Data includes:</strong> Percentiles 0-100 for each age/gender group with sufficient sample size (default: 100+ players), plus average DWZ, median DWZ, and sample statistics.</p>
        </div>

        <div class="status-section">
            <h3>Execution Status</h3>
            <div id="status-loading" class="loading">Loading status...</div>
            <div id="status-content" style="display: none;">
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Current Status</div>
                        <div id="status-running" class="status-value">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Last Execution</div>
                        <div id="status-last-execution" class="status-value">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Last Success</div>
                        <div id="status-last-success" class="status-value">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Output Files</div>
                        <div id="status-output-file" class="status-value">-</div>
                    </div>
                </div>
                <div id="status-error" style="display: none;" class="error-message"></div>
                <div style="margin-top: 20px;">
                    <button id="start-btn" class="btn" onclick="startExecution()">Start Execution</button>
                    <button id="refresh-btn" class="btn" onclick="loadStatus()">Refresh Status</button>
                </div>
            </div>
        </div>

        <div class="files-section">
            <h3>Available Files</h3>
            <div id="files-loading" class="loading">Loading files...</div>
            <div id="files-content" style="display: none;">
                <div class="files-grid">
                    <div class="gender-section">
                        <div class="gender-title">Male Players</div>
                        <ul id="male-files" class="file-list"></ul>
                    </div>
                    <div class="gender-section">
                        <div class="gender-title">Female Players</div>
                        <ul id="female-files" class="file-list"></ul>
                    </div>
                    <div class="gender-section">
                        <div class="gender-title">Diverse Players</div>
                        <ul id="divers-files" class="file-list"></ul>
                    </div>
                </div>
            </div>
            <div id="files-error" style="display: none;" class="error-message"></div>
        </div>
    </div>

    <script>
        let refreshInterval;

        function formatDateTime(dateString) {
            if (!dateString || dateString === '0001-01-01T00:00:00Z') {
                return 'Never';
            }
            return new Date(dateString).toLocaleString();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getGenderFromFilename(filename) {
            if (filename.includes('-male-')) return 'male';
            if (filename.includes('-female-')) return 'female';
            if (filename.includes('-divers-')) return 'divers';
            return 'unknown';
        }

        async function loadStatus() {
            try {
                const response = await fetch('/api/v1/somatogramm/status');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load status');
                }

                const status = data.data.status;

                document.getElementById('status-running').textContent = status.running ? 'Running' : 'Idle';
                document.getElementById('status-running').className = 'status-value ' + (status.running ? 'running' : 'success');

                document.getElementById('status-last-execution').textContent = formatDateTime(status.last_execution);
                document.getElementById('status-last-success').textContent = formatDateTime(status.last_success);
                document.getElementById('status-output-file').textContent = status.output_file || 'None';

                if (status.last_error) {
                    document.getElementById('status-error').textContent = 'Last Error: ' + status.last_error;
                    document.getElementById('status-error').style.display = 'block';
                } else {
                    document.getElementById('status-error').style.display = 'none';
                }

                document.getElementById('start-btn').disabled = status.running;

                document.getElementById('status-loading').style.display = 'none';
                document.getElementById('status-content').style.display = 'block';

                if (status.running && !refreshInterval) {
                    refreshInterval = setInterval(loadStatus, 5000);
                } else if (!status.running && refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }

            } catch (error) {
                document.getElementById('status-loading').textContent = 'Error loading status: ' + error.message;
            }
        }

        async function loadFiles() {
            try {
                const response = await fetch('/api/v1/somatogramm/files');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load files');
                }

                const files = data.data || [];

                const genderFiles = {
                    male: [],
                    female: [],
                    divers: []
                };

                files.forEach(file => {
                    const gender = getGenderFromFilename(file.name);
                    if (genderFiles[gender]) {
                        genderFiles[gender].push(file);
                    }
                });

                ['male', 'female', 'divers'].forEach(gender => {
                    const container = document.getElementById(gender + '-files');
                    container.innerHTML = '';

                    if (genderFiles[gender].length === 0) {
                        const noFilesItem = document.createElement('li');
                        noFilesItem.className = 'no-files';
                        noFilesItem.textContent = 'No files available';
                        container.appendChild(noFilesItem);
                    } else {
                        genderFiles[gender].forEach(file => {
                            const listItem = document.createElement('li');
                            listItem.className = 'file-item';

                            const fileInfo = document.createElement('div');
                            fileInfo.className = 'file-info';

                            const fileName = document.createElement('div');
                            fileName.className = 'file-name';
                            fileName.textContent = file.name;

                            const fileMeta = document.createElement('div');
                            fileMeta.className = 'file-meta';
                            fileMeta.textContent = `${formatFileSize(file.size)} • ${formatDateTime(file.mod_time)}`;

                            fileInfo.appendChild(fileName);
                            fileInfo.appendChild(fileMeta);

                            const downloadLink = document.createElement('a');
                            downloadLink.href = `/api/v1/somatogramm/download/${file.name}`;
                            downloadLink.className = 'download-btn';
                            downloadLink.textContent = 'Download';
                            downloadLink.target = '_blank';

                            listItem.appendChild(fileInfo);
                            listItem.appendChild(downloadLink);
                            container.appendChild(listItem);
                        });
                    }
                });

                document.getElementById('files-loading').style.display = 'none';
                document.getElementById('files-content').style.display = 'block';
                document.getElementById('files-error').style.display = 'none';

            } catch (error) {
                document.getElementById('files-loading').style.display = 'none';
                document.getElementById('files-error').textContent = 'Error loading files: ' + error.message;
                document.getElementById('files-error').style.display = 'block';
            }
        }

        async function startExecution() {
            try {
                document.getElementById('start-btn').disabled = true;

                const response = await fetch('/api/v1/somatogramm/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to start execution');
                }

                setTimeout(() => {
                    loadStatus();
                    loadFiles();
                }, 1000);

            } catch (error) {
                alert('Error starting execution: ' + error.message);
                document.getElementById('start-btn').disabled = false;
            }
        }

        // Initialize page
        window.addEventListener('load', () => {
            loadStatus();
            loadFiles();
        });

        // Cleanup interval on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>